import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import static org.junit.jupiter.api.Assertions.*;

class FundTransferServiceTest {

    private FundTransferService fundTransferService;
    private TestAccountService accountService;

    @BeforeEach
    void setUp() {
        accountService = new TestAccountService();
        fundTransferService = new FundTransferService(accountService);

        // Initialize sample accounts
        accountService.setAccountDetails("A1", 1000.0, true);
        accountService.setAccountDetails("A2", 500.0, true);
        accountService.setAccountDetails("A3", 0.0, false); // non-existent account
    }

    @Test
    void testInvalidAmount() {
        String result = fundTransferService.transfer("A1", "A2", -100);
        assertEquals("FAILURE: Invalid amount", result);
    }

    @Test
    void testSameAccountTransfer() {
        String result = fundTransferService.transfer("A1", "A1", 200);
        assertEquals("FAILURE: Source and destination cannot be same", result);
    }

    @Test
    void testInsufficientFunds() {
        String result = fundTransferService.transfer("A1", "A2", 2000);
        assertEquals("FAILURE: Insufficient funds", result);
    }

    @Test
    void testDestinationAccountNotFound() {
        String result = fundTransferService.transfer("A1", "A3", 100);
        assertEquals("FAILURE: Destination account not found", result);
    }

    @Test
    void testSuccessfulTransfer() {
        String result = fundTransferService.transfer("A1", "A2", 200);
        assertEquals("SUCCESS: Transfer completed", result);

        assertEquals(800.0, accountService.getBalance("A1"));
        assertEquals(700.0, accountService.getBalance("A2"));
    }

    @Test
    void testTransactionError() {
        accountService.failNextDebit = true;
        String result = fundTransferService.transfer("A1", "A2", 100);
        assertEquals("FAILURE: Transaction error", result);
    }

    // âœ… Simple hardcoded test account service (no collections)
    private static class TestAccountService implements AccountService {
        private String acc1 = "A1";
        private String acc2 = "A2";
        private String acc3 = "A3";
        private double bal1 = 0.0;
        private double bal2 = 0.0;
        private double bal3 = 0.0;
        private boolean acc1Exists = false;
        private boolean acc2Exists = false;
        private boolean acc3Exists = false;
        boolean failNextDebit = false;

        void setAccountDetails(String accNo, double balance, boolean exists) {
            if (accNo.equals(acc1)) {
                bal1 = balance; acc1Exists = exists;
            } else if (accNo.equals(acc2)) {
                bal2 = balance; acc2Exists = exists;
            } else if (accNo.equals(acc3)) {
                bal3 = balance; acc3Exists = exists;
            }
        }

        @Override
        public boolean exists(String accountNumber) {
            return (accountNumber.equals(acc1) && acc1Exists)
                || (accountNumber.equals(acc2) && acc2Exists)
                || (accountNumber.equals(acc3) && acc3Exists);
        }

        @Override
        public double getBalance(String accountNumber) {
            if (accountNumber.equals(acc1)) return bal1;
            if (accountNumber.equals(acc2)) return bal2;
            if (accountNumber.equals(acc3)) return bal3;
            return 0.0;
        }

        @Override
        public boolean debit(String accountNumber, double amount) {
            if (failNextDebit) { failNextDebit = false; return false; }

            if (accountNumber.equals(acc1) && bal1 >= amount) {
                bal1 -= amount; return true;
            } else if (accountNumber.equals(acc2) && bal2 >= amount) {
                bal2 -= amount; return true;
            }
            return false;
        }

        @Override
        public boolean credit(String accountNumber, double amount) {
            if (accountNumber.equals(acc1) && acc1Exists) {
                bal1 += amount; return true;
            } else if (accountNumber.equals(acc2) && acc2Exists) {
                bal2 += amount; return true;
            }
            return false;
        }
    }
}
