package com.example.funds;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import static org.mockito.Mockito.*;
import static org.junit.jupiter.api.Assertions.*;

class FundTransferServiceTest {

    private CustomerService customerService;
    private AccountService accountService;
    private FundTransferService fundTransferService;

    @BeforeEach
    void setUp() {
        customerService = mock(CustomerService.class);
        accountService = mock(AccountService.class);
        fundTransferService = new FundTransferService(customerService, accountService);
    }

    @Test
    void testInvalidAmount() {
        String result = fundTransferService.transferFund("C1", "C2", -100);
        assertEquals("FAILURE: Invalid amount", result);
    }

    @Test
    void testInvalidSender() {
        when(customerService.isValidCustomer("C1")).thenReturn(false);

        String result = fundTransferService.transferFund("C1", "C2", 100);
        assertEquals("FAILURE: Invalid sender", result);
    }

    @Test
    void testInvalidReceiver() {
        when(customerService.isValidCustomer("C1")).thenReturn(true);
        when(customerService.isValidCustomer("C2")).thenReturn(false);

        String result = fundTransferService.transferFund("C1", "C2", 100);
        assertEquals("FAILURE: Invalid receiver", result);
    }

    @Test
    void testInsufficientFunds() {
        when(customerService.isValidCustomer("C1")).thenReturn(true);
        when(customerService.isValidCustomer("C2")).thenReturn(true);
        when(accountService.getBalance("C1")).thenReturn(50.0);

        String result = fundTransferService.transferFund("C1", "C2", 100);
        assertEquals("FAILURE: Insufficient funds", result);
    }

    @Test
    void testSuccessfulTransfer() {
        when(customerService.isValidCustomer("C1")).thenReturn(true);
        when(customerService.isValidCustomer("C2")).thenReturn(true);
        when(accountService.getBalance("C1")).thenReturn(1000.0);
        when(accountService.debit("C1", 200.0)).thenReturn(true);
        when(accountService.credit("C2", 200.0)).thenReturn(true);

        String result = fundTransferService.transferFund("C1", "C2", 200);

        assertEquals("SUCCESS: Transfer completed", result);

        // Verify that interactions happened
        verify(accountService).getBalance("C1");
        verify(accountService).debit("C1", 200.0);
        verify(accountService).credit("C2", 200.0);
    }

    @Test
    void testTransactionFailure() {
        when(customerService.isValidCustomer("C1")).thenReturn(true);
        when(customerService.isValidCustomer("C2")).thenReturn(true);
        when(accountService.getBalance("C1")).thenReturn(1000.0);
        when(accountService.debit("C1", 200.0)).thenReturn(false);
        when(accountService.credit("C2", 200.0)).thenReturn(true);

        String result = fundTransferService.transferFund("C1", "C2", 200);

        assertEquals("FAILURE: Transaction error", result);
    }
}

